name: CD - Deploy to ECS

on:
  push:
    branches: [ release ]
  workflow_dispatch:

env:
  # â­ ë¦¬ì „ ë¶„ë¦¬
  ECS_REGION: ap-northeast-2
  ECR_PUBLIC_REGION: us-east-1

  ECS_CLUSTER: monew-cluster-1
  ECR_REPOSITORY: public.ecr.aws/s7e2q2h9/monew

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: api
            dockerfile: Dockerfile.api
            tag: monew-api
            task_definition: monew-api-task
            ecs_service: monew-api-service
          - name: batch
            dockerfile: Dockerfile.batch
            tag: monew-batch
            task_definition: monew-batch-task
            ecs_service: monew-batch-service
          - name: monitor
            dockerfile: Dockerfile.monitor
            tag: monew-monitor
            task_definition: monew-monitor-task
            ecs_service: monew-monitor-service
          - name: prometheus
            dockerfile: Dockerfile.prom
            tag: prometheus
            task_definition: monew-prometheus-task
            ecs_service: monew-prometheus-service
          - name: grafana
            dockerfile: Dockerfile.grafana
            tag: grafana
            task_definition: monew-grafana-task
            ecs_service: monew-grafana-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===== Public ECR (us-east-1) =====
      - name: Configure AWS credentials for Public ECR
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.ECR_PUBLIC_REGION }}

      - name: Debug AWS caller identity (ECR creds)
        run: aws sts get-caller-identity --region ${{ env.ECR_PUBLIC_REGION }}

      - name: Login to Public ECR
        run: |
          aws ecr-public get-login-password --region ${{ env.ECR_PUBLIC_REGION }} | \
          docker login --username AWS --password-stdin public.ecr.aws

      - name: Build and push ${{ matrix.service.name }} image
        run: |
          set -euo pipefail
          docker build -f ${{ matrix.service.dockerfile }} \
            -t ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-${{ github.sha }} \
            -t ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest .
          docker push ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-${{ github.sha }}
          docker push ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest

      # ===== ECS (ap-northeast-2) =====
      - name: Configure AWS credentials for ECS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.ECS_REGION }}

      - name: Debug AWS caller identity (ECS creds)
        run: aws sts get-caller-identity --region ${{ env.ECS_REGION }}

      - name: Dry-run DescribeTaskDefinition (debug)
        run: |
          set -euo pipefail
          echo "Family: ${{ matrix.service.task_definition }}  Region: ${{ env.ECS_REGION }}"
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --region ${{ env.ECS_REGION }} \
            --query 'taskDefinition.taskDefinitionArn' --output text

      - name: Update task definition
        run: |
          set -euo pipefail
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --region ${{ env.ECS_REGION }} \
            --query 'taskDefinition' --output json)

          NEW_TASK_DEFINITION=$(echo "$TASK_DEFINITION" | jq \
            --arg IMAGE "${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest" \
            '.containerDefinitions[0].image = $IMAGE
             | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION" \
            --region ${{ env.ECS_REGION }} \
            --query 'taskDefinition.taskDefinitionArn' --output text)

          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV

      - name: Update ECS service
        run: |
          set -euo pipefail
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ matrix.service.ecs_service }} \
            --task-definition ${{ env.NEW_TASK_ARN }} \
            --desired-count 1 \
            --force-new-deployment \
            --region ${{ env.ECS_REGION }}
          echo "âœ… ${{ matrix.service.name }} service deployed!"

      - name: Wait for service stability
        run: |
          set -euo pipefail
          echo "Waiting for service to be stable..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ matrix.service.ecs_service }} \
            --region ${{ env.ECS_REGION }}
          echo "ðŸš€ ${{ matrix.service.name }} deployment completed!"
