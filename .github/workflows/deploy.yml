name: CD - Deploy to ECS

on:
  push:
    branches:
      - release
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: monew-cluster-1
  ECR_REPOSITORY: public.ecr.aws/s7e2q2h9/monew

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: api
            dockerfile: Dockerfile.api
            tag: monew-api
            task_definition: monew-api-task
            ecs_service: monew-api-service
          - name: batch
            dockerfile: Dockerfile.batch
            tag: monew-batch
            task_definition: monew-batch-task
            ecs_service: monew-batch-service
          - name: monitor
            dockerfile: Dockerfile.monitor
            tag: monew-monitor
            task_definition: monew-monitor-task
            ecs_service: monew-monitor-service
          - name: prometheus
            dockerfile: Dockerfile.prom
            tag: prometheus
            task_definition: monew-prometheus-task
            ecs_service: monew-prometheus-service
          - name: grafana
            dockerfile: Dockerfile.grafana
            tag: grafana
            task_definition: monew-grafana-task
            ecs_service: monew-grafana-service

    steps:
      # ========================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================
      # 2. Public ECR ë¡œê·¸ì¸ (us-east-1)
      # âš ï¸ ì¤‘ìš”: Public ECRì€ us-east-1ë§Œ ì‚¬ìš©!
      # ========================================
      - name: Configure AWS credentials for Public ECR
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: us-east-1  # â­ Public ECRì€ us-east-1ë§Œ ì‚¬ìš©

      - name: Debug AWS caller identity
        run: aws sts get-caller-identity --region ${{ env.AWS_REGION }}

      - name: Login to Public ECR
        run: |
          aws ecr-public get-login-password --region us-east-1 | \
          docker login --username AWS --password-stdin public.ecr.aws

      # ========================================
      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      # ========================================
      - name: Build and push ${{ matrix.service.name }} image
        run: |
          # ë¹Œë“œ
          docker build \
            -f ${{ matrix.service.dockerfile }} \
            -t ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-${{ github.sha }} \
            -t ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest \
            .
          
          # í‘¸ì‹œ
          docker push ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-${{ github.sha }}
          docker push ${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest

      # ========================================
      # 4. ECS ë°°í¬ (ap-northeast-2)
      # âš ï¸ ECSëŠ” ì‹¤ì œ ë¦¬ì „ ì‚¬ìš©
      # ========================================
      - name: Configure AWS credentials for ECS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}  # â­ ECSëŠ” ap-northeast-2
      - name: Debug AWS caller identity (ECS creds)
        run: aws sts get-caller-identity --region ${{ env.AWS_REGION }}

      - name: Dry-run DescribeTaskDefinition (debug)
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --region ${{ env.AWS_REGION }} \
            --query 'taskDefinition.taskDefinitionArn' --output text      

      - name: Update task definition
        run: |
          # í˜„ìž¬ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition ${{ matrix.service.task_definition }} \
            --query 'taskDefinition')

          # ìƒˆ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq \
            --arg IMAGE "${{ env.ECR_REPOSITORY }}:${{ matrix.service.tag }}-latest" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')

          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION" | \
            jq -r '.taskDefinition.taskDefinitionArn')

          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ matrix.service.ecs_service }} \
            --task-definition ${{ env.NEW_TASK_ARN }} \
            --desired-count 1 \
            --force-new-deployment

          echo "âœ… ${{ matrix.service.name }} service deployed!"

      - name: Wait for service stability
        run: |
          echo "Waiting for service to be stable..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ matrix.service.ecs_service }}
          
          echo "ðŸš€ ${{ matrix.service.name }} deployment completed!"